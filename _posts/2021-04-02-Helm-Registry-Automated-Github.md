---
excerpt_separator: <!--more-->
---
# Helm registry with Terraform and Github Actions on Azure Storage

This article is a guide to create a Terraform script to make a storage account as a Registry Helm. The script is instantiated in a Github Actions pipeline. 

<!--more-->
## Requirement

To use the resources in this article you will need:

- Terraform v0.14.9 ( to test on local workstation)
- Azure permission allowing to create group resource and a storage account (as well as its container). This will be used to upload file too
- A Github account


## Implementation 

    Disclamer: 

        - The article does not discuss the tfstates generated by the pipeline

        - The storage account is created in public. If you want to apply this article in production, you will need to audit the networks that have the right to request your storage account.
 
### Terraform

The following sources are used to provision a storage account as well as its container.

The code is split into several files.
- main.tf: grouping together the terraform resources created
- provider.tf: grouping together the resources specific to the providers
- vars.tf: grouping together the variables instantiated in the terraform
- output.tf: grouping the output of the terraform script

main.tf : 

``` hcl
resource "azurerm_resource_group" "rg" {
  name     = lower(var.sa_name)
  location = "West Europe"
}

resource "azurerm_storage_account" "sa" {
  name                     = lower(var.sa_name)
  resource_group_name      = azurerm_resource_group.rg.name
  location                 = azurerm_resource_group.rg.location
  account_tier             = "Standard"
  account_replication_type = "LRS"
  enable_https_traffic_only = true
  allow_blob_public_access = true

  tags = {
    environment = var.env
  }
}

resource "azurerm_storage_container" "container" {
  name                  = lower(var.ctn_name)
  storage_account_name  = azurerm_storage_account.sa.name
  container_access_type = "blob"
}


```

This script will create a resource group and add a storage account with this container. 

provider.tf : 

```hcl
terraform {
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "2.53.0"
    }
  }
}

provider "azurerm" {
  features {

  }
}
```

vars.tf :
```hcl
variable "env" {
  default="testing"  
}
variable "ctn_name" {
  default="helm"
}
variable "sa_name" {
  default="nospofhelmreg"
}
```
If you wish customize the name with env var you can do this with TF_VAR prefix and export it as env variable.

outputs.tf

```hcl
output "url_blob" {
  value=azurerm_storage_account.sa.primary_blob_endpoint
  }

```

### Github Actions

The following allows you to create an action github. This github action is split into several parts:

- Terraform Init:

```yaml
    - name: Terraform Init
      run: terraform init
```
- Terraform plan :
```yaml
    - name: Terraform Plan
      run: terraform plan
```
- Terraform apply :
```yaml
    - name: Terraform Apply
      run: terraform apply -auto-approve
```
- Terraform output to file : 
```yaml

      - name: Terraform Output to file
        run: terraform output url_blob >> ./output
      
```
- Helm create index file:
```yaml
  
      - name: Helm create index
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm repo index --url "https://${TF_VAR_sa_name}.blob.core.windows.net/${TF_VAR_ctn_name}" .

```
- Azure login with azure cli:
```yaml

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

```
- Azure cli upload index.yaml : 
```yaml

      - name: Azure CLI script file
        uses: azure/CLI@v1
        with:
          azcliversion: 2.0.72
          inlineScript: |
            export AZURE_STORAGE_ACCOUNT=${TF_VAR_sa_name}
            export  AZURE_STORAGE_KEY=$(az storage account keys list --resource-group ${TF_VAR_sa_name} --account-name ${TF_VAR_sa_name} | grep -m 1 value | awk -F'"' '{print $4}')
            az storage blob upload --container-name  ${TF_VAR_ctn_name} --file index.yaml  --name index.yaml 

```
- Test Helm repo :
```yaml

      - name: Test the repo helm
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm repo add azure "https://${TF_VAR_sa_name}.blob.core.windows.net/${TF_VAR_ctn_name}"

```
- Update Helm Repo:
```yaml

      - name: Update repo
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm repo update

```
- Terraform destroy if pipeline failed: 
```yaml

      - name: Terraform Destroy
        run: terraform destroy -auto-approve 
        if: failure()
```

The full actions github script is as follows:

```yaml
name: Terraform Plan

on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{secrets.ARM_CLIENT_SECRET}}
      ARM_SUBSCRIPTION_ID:  ${{secrets.ARM_SUBSCRIPTION_ID}}
      ARM_TENANT_ID:  ${{secrets.ARM_TENANT_ID}}
      TF_VAR_ctn_name: helm
      TF_VAR_sa_name: nospofhelmreg

    steps:
      - uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan

      - name: Terraform Apply
        run: terraform apply -auto-approve

      - name: Terraform Output to file
        run: terraform output url_blob >> ./output
        
      - name: Helm create index
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm repo index --url "https://${TF_VAR_sa_name}.blob.core.windows.net/${TF_VAR_ctn_name}" .

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure CLI script file
        uses: azure/CLI@v1
        with:
          azcliversion: 2.0.72
          inlineScript: |
            export AZURE_STORAGE_ACCOUNT=${TF_VAR_sa_name}
            export  AZURE_STORAGE_KEY=$(az storage account keys list --resource-group ${TF_VAR_sa_name} --account-name ${TF_VAR_sa_name} | grep -m 1 value | awk -F'"' '{print $4}')
            az storage blob upload --container-name  ${TF_VAR_ctn_name} --file index.yaml  --name index.yaml 

      - name: Test the repo helm
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm repo add azure "https://${TF_VAR_sa_name}.blob.core.windows.net/${TF_VAR_ctn_name}"

      - name: Update repo
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm repo update

      - name: Terraform Destroy
        run: terraform destroy -auto-approve 
        if: failure()

```

## Secrets Github : 

To used this article, you must specify the following secret : 


![Secrets](/assets/img/2021-04-02-Helm-Registry-Automated-Github.png)


### Sources : 

The sources that were used in this article:

- https://github.com/marketplace/actions/helm-3
- https://github.com/marketplace/actions/azure-cli-action
- https://jessicadeen.com/how-to-create-a-public-helm-repo-using-azure-storage/
